export const metadata = {
  title: 'Authentication',
  description:
    'Learn how to authenticate Power Platform Tool Box with your Dataverse environments using interactive login, OAuth app registration, or username/password.',
}

export const sections = [
  { title: 'Authentication Methods', id: 'authentication-methods' },
  { title: 'Security Features', id: 'security-features' },
  { title: 'Managing Connections', id: 'managing-connections' },
  { title: 'Troubleshooting', id: 'troubleshooting' },
  { title: 'Best Practices', id: 'best-practices' },
  { title: 'Next Steps', id: 'next-steps' },
]

# Authentication

Connect Power Platform Tool Box to your Dataverse environments securely. This guide covers all authentication methods, security features, and best practices. {{ className: 'lead' }}

## Authentication Methods

Power Platform Tool Box supports three authentication methods for connecting to Dataverse environments:

## Interactive Login (Recommended)

**Best for:** End users, interactive scenarios, MFA-enabled accounts

Interactive login uses Microsoft's OAuth 2.0 flow with the Microsoft Authentication Library (MSAL):

1. Open the Connections panel
   [![Connections Panel](images/screenshots/quickstart-connection.png)](images/screenshots/quickstart-connection.png)
2. Click **"Add Connection"** in the Connections panel
   [![Connections Panel](images/screenshots/quickstart-connections-panel.png)](images/screenshots/quickstart-connections-panel.png)
3. Give your connection a name in **Connection Name**
4. Enter your **Environment URL** (e.g. `https://org.crm.dynamics.com`)
5. Ensure **Authentication Type** is set to _Microsoft Login Prompt_
6. Click **Add**
7. A browser window opens for Microsoft authentication
   [![Microsoft Login](images/screenshots/quickstart-connection-ms.png)](images/screenshots/quickstart-connection-ms.png)
8. Sign in with your credentials (MFA supported)
9. Grant consent when prompted.
10. An Authentication Successful message appears in the browser.
    [![Authentication Success message](images/screenshots/quickstart-connectionsuccess.png)](images/screenshots/quickstart-connectionsuccess.png)
11. Your connection is saved securely and is ready for use.
12. You can manage your connections in the Connections Panel, including deletion.

**Benefits:**

- Most secure method
- Supports Multi-Factor Authentication (MFA)
- Supports Conditional Access policies
- No need to handle credentials
- Automatic token refresh

<Note>
  Interactive login is the recommended method for most users. It provides the
  highest security and best user experience.
</Note>

## OAuth App Registration

**Best for:** Automation, service principals, CI/CD pipelines, background processes

Use an Entra ID application registration with client credentials:

**Prerequisites:**

<Note>
  For detailed steps on registering an application in Entra ID and Dataverse, see:

https://learn.microsoft.com/en-us/power-apps/developer/data-platform/walkthrough-register-app-azure-active-directory

</Note>

<Warning>
  Ensure you have the necessary permissions to register applications in your
  Entra ID tenant. This should only be done with consent of the Entra tenant
  owner.
</Warning>

### Register app in Entra ID:

1. Go to Entra Portal and select App registrations
2. Click "New registration"
   [![App Registration](images/screenshots/authentication-registerapp1.png)](images/screenshots/authentication-registerapp1.png)
3. Provide an appropriate name such as `PowerPlatformToolBox` (or your choice)
4. Select a supported account type: Choose an appropriate option. Recommended "Accounts in this organizational directory only"
5. Leave Redirect URI blank
6. Click "Register"

### Configure API permissions:

7. In your app registratin page, select API permissions
   [![App Registration API Permissin](images/screenshots/authentication-registerapp2.png)](images/screenshots/authentication-registerapp2.png)
8. Select Add a permission
9. Add "Dynamics CRM"
   [![App Registration Add Permission](images/screenshots/authentication-registerapp3.png)](images/screenshots/authentication-registerapp3.png)
10. Select user_impersonation then Add permissions
    [![App Registration User Impersonation](images/screenshots/authentication-registerapp4.png)](images/screenshots/authentication-registerapp4.png)
11. Select "Grant admin consent for [Your Tenant]"
    [![App Registration Grant Admin Consent](images/screenshots/authentication-registerapp5.png)](images/screenshots/authentication-registerapp5.png)
12. Confirm by clicking Yes

### Create client secret:

13. Select Certificates & secrets
    [![App Registration Certificates & Secrets](images/screenshots/authentication-registerapp6.png)](images/screenshots/authentication-registerapp6.png)
14. Click New client secret
15. Provide a description (e.g. "PPTB Secret")
    [![App Registration Certificates & Secrets](images/screenshots/authentication-registerapp7.png)](images/screenshots/authentication-registerapp7.png)
16. Select an expiration period, keep as short as possible
17. Click Add
18. Copy the secret value immediately, you won't be able to see it again
    [![App Registration Client Secret](images/screenshots/authentication-registerapp8.png)](images/screenshots/authentication-registerapp8.png)
19. You will also need the Application (client) ID and Directory (tenant) ID from the app overview page.
    [![App Registration Client ID / Tenant ID](images/screenshots/authentication-registerapp10.png)](images/screenshots/authentication-registerapp10.png)
    <Warning>
      Store the client secret securely. If compromised, it can be used to access
      your Dataverse environment.
    </Warning>

### Configure App user in Dataverse:

20. In Power Platform Admin Center, navigate to your environment
21. Go to Users
    [![Power Platform Admin Users](images/screenshots/authentication-registerapp9.png)](images/screenshots/authentication-registerapp9.png)
22. Select New app user & Add an app
    [![Power Platform Admin Add an app](images/screenshots/authentication-registerapp11.png)](images/screenshots/authentication-registerapp11.png)
23. Search for and select your registered app
    [![Power Platform Admin Add an app screen 2](images/screenshots/authentication-registerapp12.png)](images/screenshots/authentication-registerapp12.png)
24. Enter an appropriate business unit and select edit on the security roles.
25. Assign necessary security roles. This should be as minimal as possible, particularly in production environments.
26. Once complete, select Create

### Configure Power Platform Tool Box:

1. In Power Platform Tool Box, open the Connections panel and select Add
   [![PPTB Configure connection](images/screenshots/authentication-registerapp13.png)](images/screenshots/authentication-registerapp13.png)
2. Configure an appropriate connection name
3. Enter your Environment URL (e.g. `https://org.crm.dynamics.com`)
4. Select Authentication Type: Client ID/Secret
5. Enter the Client ID you saved earlier
6. Enter the Client Secret you saved earlier
7. Enter the Tenant ID you saved earlier
8. Select Test, if all is correct you will see a success message
9. Click Add to save the connection securely
   [![PPTB Configure connection](images/screenshots/authentication-registerapp14.png)](images/screenshots/authentication-registerapp14.png)

**Benefits:**

- Suitable for automation
- No interactive prompts
- Service principal support
- Fine-grained permissions

<Warning>
  Store tenant, client id & client secrets securely. Never commit them to source
  control or share them publicly.
</Warning>

### Username/Password

**Best for:** Development, testing, POC scenarios

<Warning>
  **Not recommended for production use.**

This method: 
- Cannot bypass MFA
- Does not support Conditional Access
- Requires storing credentials
- May violate security policies

</Warning>
Direct authentication with username and password:

**Setup:**

```
Environment URL: https://org.crm.dynamics.com
Auth Method: Username/Password
Username: user@domain.com
Password: your-password
```

Use this method only for:

- Local development environments
- Testing and proof-of-concepts
- Environments without MFA requirements

## Security Features

### Encrypted Storage

All sensitive credentials are encrypted using OS-native secure storage:

- **macOS:** Keychain
- **Windows:** DPAPI (Data Protection API)
- **Linux:** libsecret

**Encrypted fields:**

- Client ID
- Client Secret
- Access Token
- Refresh Token
- Password

### Automatic Migration

If you're upgrading from an older version:

- Plain-text connections are automatically encrypted on first launch
- No manual intervention required
- Backwards compatible

### Token Management

- Access tokens automatically refreshed before expiration
- Refresh tokens securely stored and rotated
- Failed refresh triggers re-authentication
- No plaintext token storage

## Managing Connections

### Add Connection

1. Click **"Add Connection"** button
2. Fill in connection details
3. Select authentication method
4. Click **"Connect"**
5. Complete authentication flow

### Edit Connection

1. Right-click connection in list
2. Select **"Edit"**
3. Modify details (name, URL, etc.)
4. Re-authenticate if changing credentials

### Delete Connection

1. Right-click connection in list
2. Select **"Delete"**
3. Confirm deletion
4. Encrypted credentials are securely removed

### Set Active Connection

1. Click on a connection in the list
2. Connection becomes active
3. Tools use the active connection
4. Active connection highlighted in UI

## Troubleshooting

### Connection Failed

**Symptom:** "Failed to connect" error

**Solutions:**

- Verify environment URL is correct
- Check network connectivity
- Ensure credentials are valid
- Verify app registration permissions (OAuth)
- Check MFA/Conditional Access policies

### Token Expired

**Symptom:** "Unauthorized" or "Token expired" error

**Solutions:**

- PPTB automatically refreshes tokens
- If refresh fails, re-authenticate
- Check refresh token is not revoked
- Verify app registration is not disabled

### MFA Required

**Symptom:** "MFA required" error with username/password

**Solution:**

- Use Interactive Login instead
- Username/password cannot bypass MFA
- Configure OAuth app registration for automation

### Insufficient Permissions

**Symptom:** "Access denied" or "Insufficient privileges"

**Solutions:**

- Verify user has necessary security roles in Dataverse
- Check app registration API permissions (OAuth)
- Ensure admin consent granted for app permissions
- Review Dataverse security settings

## Best Practices

<Row>
  <Col>
    **For End Users** - Use Interactive Login - Enable MFA on your account -
    Don't share connections - Review active connections regularly
  </Col>
  <Col>
    **For Developers** - Use OAuth for automation - Rotate client secrets
    regularly - Use service principals for CI/CD - Never commit credentials to
    code
  </Col>
  <Col>
    **For Administrators** - Enforce MFA policies - Use Conditional Access -
    Review app registrations - Audit connection usage
  </Col>
</Row>

## Next Steps

<div className="not-prose flex gap-3">
  <Button href="/quickstart" variant="text" arrow="right">
    <>Quick Start Guide</>
  </Button>
  <Button href="/tool-development" variant="text" arrow="right">
    <>Build Tools</>
  </Button>
</div>
