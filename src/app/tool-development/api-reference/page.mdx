export const metadata = {
  title: 'API Reference',
  description:
    'Complete API reference for ToolBox API and Dataverse API available to tool developers',
}

export const sections = [
  { title: 'ToolBox API', id: 'toolbox-api' },
  { title: 'Dataverse API', id: 'dataverse-api' },
  { title: 'Error Handling', id: 'error-handling' },
  { title: 'Next Steps', id: 'next-steps' },
]

# API Reference

Comprehensive reference for the ToolBox API and Dataverse API available to all tools running in Power Platform ToolBox. {{ className: 'lead' }}

<Note>
  For complete TypeScript definitions, install the `@pptb/types` package:
  ```bash npm install --save-dev @pptb/types ```
</Note>

## ToolBox API {{ anchor: true }}

The ToolBox API provides access to platform features and utilities.

### Connections

Get information about the active Dataverse connection.

#### `toolboxAPI.connections.getActiveConnection()`

Returns the currently active connection or null if none is selected.

```typescript
const connection = await toolboxAPI.connections.getActiveConnection()

if (connection) {
  console.log('Connected to:', connection.name)
  console.log('Environment:', connection.environment)
  console.log('API URL:', connection.apiUrl)
} else {
  console.log('No active connection')
}
```

**Returns:** `Promise<DataverseConnection | null>`

```typescript
interface DataverseConnection {
  id: string // Unique identifier of the connection
  name: string // Friendly name of the connection
  url: string // Base URL of the Dataverse instance
  environment: string // Dev | Test | UAT | Prod - Defines the type as established by the user
  clientId: string // Application (client) ID used for authentication
  tenantId: string // Tenant ID of the Azure AD tenant
  createdAt: string // ISO date string of when the connection was created
  lastUsedAt: string // ISO date string of when the connection was last used
}
```

### Secondary Connections

As a tool developer, you may require access to a second Dataverse connections. This can be useful for copying data or configuration between environments.

To enable this feature, you must update the package.json file to indicate your tool requires multiconnections.

```json
{
  "name": "@toolname",
  "version": "0.1.10",
  "displayName": " My Awesome Tool",
  "description": "A Power Platform Tool Box tool to do awesome things",
  "main": "index.html",
  "contributors": [
    "Awesome Developer "
  ],
  "keywords": [
    "powerplatform",
    "dataverse",
    "toolbox"
  ],
  // This section enables multiple connections
  "features": {
    "multiConnection": "required" or "optional"
  },
```

When the user opens your tool, they are presented with the option to connect to a primary and secondary environment.

#### `toolboxAPI.connections.getSecondaryConnection()`

Returns the currently active secoondary connection or null if none is configured.

```typescript
const secondaryConnection =
  await toolboxAPI.connections.getSecondaryConnection()

if (secondaryConnection) {
  console.log('Connected to:', secondaryConnection.name)
  console.log('Environment:', secondaryConnection.environment)
  console.log('API URL:', secondaryConnection.apiUrl)
} else {
  console.log('No active secondary connection')
}
```

**Returns:** `Promise<DataverseConnection | null>`

```typescript
interface DataverseConnection {
  id: string // Unique identifier of the connection
  name: string // Friendly name of the connection
  url: string // Base URL of the Dataverse instance
  environment: string // Dev | Test | UAT | Prod - Defines the type as established by the user
  clientId: string // Application (client) ID used for authentication
  tenantId: string // Tenant ID of the Azure AD tenant
  createdAt: string // ISO date string of when the connection was created
  lastUsedAt: string // ISO date string of when the connection was last used
}
```

When interacting with dataverse and you want to use the secondary connection, pass the connectionTarget parameter as 'secondary'. ConnectionTarget is optional and defaults to 'primary'.

```typescript
// Example useage of dataverseAPI using secondary connection
const myTables = await dataverseAPI.getAllEntitiesMetadata(
  ['logicalName'],
  'secondary',
)
```

###

### Utils

Utility functions for notifications, clipboard, file operations, and more.

#### `toolboxAPI.utils.showNotification(options)`

Display a notification to the user.

```typescript
await toolboxAPI.utils.showNotification({
  title: 'Success',
  body: 'Operation completed successfully',
  type: 'success',
  duration: 3000, // Auto-dismiss after 3 seconds
})
```

**Parameters:**

- `options` - Notification configuration object

**Types:**

- `type`: `'info' | 'success' | 'warning' | 'error'`
- `duration`: Number in milliseconds (0 = persistent)

#### `toolboxAPI.utils.copyToClipboard(text)`

Copy text to the system clipboard.

```typescript
const data = JSON.stringify({ accounts: [], contacts: [] }, null, 2)
await toolboxAPI.utils.copyToClipboard(data)

await toolboxAPI.utils.showNotification({
  title: 'Copied',
  body: 'Data copied to clipboard',
  type: 'success',
})
```

#### `toolboxAPI.utils.saveFile(filename, content)`

Save content to a file with user-selected location.

```typescript
const jsonData = { accounts: [], contacts: [] }
const filePath = await toolboxAPI.utils.saveFile(
  'export.json',
  JSON.stringify(jsonData, null, 2),
)

if (filePath) {
  console.log('File saved to:', filePath)
} else {
  console.log('Save cancelled')
}
```

**Returns:** `Promise<string | null>` - File path or null if cancelled

#### `toolboxAPI.utils.selectPath(options?)`

Open a native dialog to select either a file or a folder and return the chosen path.

```typescript
// Select a folder
const folderPath = await toolboxAPI.utils.selectPath({
  type: 'folder',
  title: 'Select Export Folder',
})

if (folderPath) {
  console.log('Selected folder:', folderPath)
} else {
  console.log('Selection cancelled')
}
```

```typescript
// Select a file
const filePath = await toolboxAPI.utils.selectPath({
  type: 'file',
  title: 'Select Configuration File',
  filters: [
    { name: 'JSON Files', extensions: ['json'] },
    { name: 'All Files', extensions: ['*'] },
  ],
})

if (filePath) {
  console.log('Selected file:', filePath)
}
```

**Parameters:**

- `options` - Optional configuration object
  - `type`: `'file' | 'folder'` - Type of selection dialog
  - `title`: `string` - Dialog window title
  - `filters`: `Array<{ name: string; extensions: string[] }>` - File filters (file dialogs only)

**Returns:** `Promise<string | null>` - Selected path or null if cancelled

#### `toolboxAPI.utils.getCurrentTheme()`

Get the current application theme.

```typescript
const theme = await toolboxAPI.utils.getCurrentTheme()
document.body.classList.add(`theme-${theme}`)
```

**Returns:** `Promise<'light' | 'dark'>`

#### `toolboxAPI.utils.showLoading(message)` / `hideLoading()`

Show/hide a loading overlay.

```typescript
await toolboxAPI.utils.showLoading('Fetching data from Dataverse...')

try {
  // Perform long-running operations
  const data = await fetchLargeDataset()
  processData(data)

  await toolboxAPI.utils.showNotification({
    title: 'Success',
    body: 'Data processed successfully',
    type: 'success',
  })
} finally {
  await toolboxAPI.utils.hideLoading()
}
```

#### `toolboxAPI.utils.executeParallel(...promises)`

Execute multiple async operations in parallel.

```typescript
const [account, contact, opportunities] =
  await toolboxAPI.utils.executeParallel(
    dataverseAPI.retrieve('account', accountId, ['name']),
    dataverseAPI.retrieve('contact', contactId, ['fullname']),
    dataverseAPI.fetchXmlQuery(opportunityFetchXml),
  )

console.log('All data fetched:', account, contact, opportunities)
```

### Settings

Store and retrieve tool-specific settings.

#### `toolboxAPI.settings.get(key, defaultValue?)`

Retrieve a setting value for your tool.

```typescript
const theme = await toolboxAPI.settings.get('theme', 'light')
const pageSize = await toolboxAPI.settings.get('pageSize', 25)
```

#### `toolboxAPI.settings.set(key, value)`

Save a setting value for your tool.

```typescript
await toolboxAPI.settings.set('theme', 'dark')
await toolboxAPI.settings.set('pageSize', 50)
```

#### `toolboxAPI.settings.remove(key)`

Remove a setting.

```typescript
await toolboxAPI.settings.remove('theme')
```

#### `toolboxAPI.settings.clear()`

Clear all settings for your tool.

```typescript
await toolboxAPI.settings.clear()
```

### Terminal

Create and manage terminal sessions (context-aware to your tool).

#### `toolboxAPI.terminal.create(options)`

Create a new terminal.

```typescript
const terminal = await toolboxAPI.terminal.create({
  name: 'Build Terminal',
  cwd: '/path/to/project',
  env: {
    NODE_ENV: 'production',
  },
})

console.log('Terminal created:', terminal.id)
```

#### `toolboxAPI.terminal.execute(terminalId, command)`

Execute a command in a terminal.

```typescript
const result = await toolboxAPI.terminal.execute(terminal.id, 'npm install')

if (result.exitCode === 0) {
  console.log('Command completed successfully')
} else {
  console.error('Command failed:', result.error)
}
```

#### `toolboxAPI.terminal.setVisibility(terminalId, visible)`

Show or hide a terminal's UI panel.

```typescript
await toolboxAPI.terminal.setVisibility(terminal.id, true)
```

#### `toolboxAPI.terminal.list()`

List all terminals created by your tool.

```typescript
const terminals = await toolboxAPI.terminal.list()
console.log(`This tool has ${terminals.length} terminals`)
```

#### `toolboxAPI.terminal.close(terminalId)`

Close a terminal.

```typescript
await toolboxAPI.terminal.close(terminal.id)
```

### Events

Subscribe to platform events.

#### `toolboxAPI.events.on(handler)`

Subscribe to events relevant to your tool.

```typescript
toolboxAPI.events.on((event, payload) => {
  console.log('Event:', event, 'Data:', payload)

  switch (event) {
    case 'connection:updated':
      refreshConnectionInfo()
      break
    case 'connection:activated':
      handleConnectionActivated(payload)
      break
    case 'settings:updated':
      if (payload && payload.theme) {
        applyTheme(payload.theme)
      }
      break
  }
})
```

**Event Types:**

- `connection:updated` - Active connection changed
- `connection:activated` - Connection activated
- `connection:deactivated` - Connection deactivated
- `settings:updated` - Settings, including Theme has been updated
- `tool:activated` - Your tool tab activated
- `tool:deactivated` - Your tool tab deactivated

## Dataverse API {{ anchor: true }}

Complete HTTP client for interacting with Microsoft Dataverse.

### CRUD Operations

Each method accepts an optional `connectionTarget` parameter to specify which connection to use (`'primary' | 'secondary'`). Defaults to `'primary'`.

#### `dataverseAPI.create(entityName, data, connectionTarget?)`

Create a new record.

```typescript
const accountId = await dataverseAPI.create('account', {
  name: 'Contoso Ltd',
  telephone1: '555-1234',
  websiteurl: 'https://contoso.com',
})

console.log('Created account:', accountId)
```

#### `dataverseAPI.retrieve(entityName, id, columns?, connectionTarget?)`

Retrieve a single record.

```typescript
const account = await dataverseAPI.retrieve('account', accountId, [
  'name',
  'telephone1',
  'emailaddress1',
])

console.log('Account name:', account.name)
```

#### `dataverseAPI.update(entityName, id, data, connectionTarget?)`

Update an existing record.

```typescript
await dataverseAPI.update('account', accountId, {
  telephone1: '555-5678',
  websiteurl: 'https://www.contoso.com',
})
```

#### `dataverseAPI.delete(entityName, id, connectionTarget?)`

Delete a record.

```typescript
/// Deleting an account record using the primary connection
await dataverseAPI.delete('account', accountId)
```

```typescript
/// Deleting an account record using the secondary connection
await dataverseAPI.delete('account', accountId, 'secondary')
```

### Queries

#### `dataverseAPI.fetchXmlQuery(fetchXml, connectionTarget? )`

Execute a FetchXML query.

```typescript
const fetchXml = `
  <fetch top="10">
    <entity name="account">
      <attribute name="name" />
      <attribute name="accountid" />
      <filter>
        <condition attribute="statecode" operator="eq" value="0" />
      </filter>
      <order attribute="name" />
    </entity>
  </fetch>
`

const result = await dataverseAPI.fetchXmlQuery(fetchXml)

result.value.forEach((account) => {
  console.log('Account:', account.name)
})
```

#### `dataverseAPI.retrieveMultiple(entityName, options, connectionTarget?)`

Retrieve multiple records with OData query options.

```typescript
const accounts = await dataverseAPI.retrieveMultiple('account', {
  select: ['name', 'accountid'],
  filter: 'statecode eq 0',
  orderBy: ['name'],
  top: 10,
})

console.log(`Found ${accounts.value.length} accounts`)
```

### Metadata

#### `dataverseAPI.getEntityMetadata(entityName, connectionTarget?)`

Get entity metadata.

```typescript
const metadata = await dataverseAPI.getEntityMetadata('account')

console.log('Display Name:', metadata.DisplayName.UserLocalizedLabel.Label)
console.log('Primary Key:', metadata.PrimaryIdAttribute)
```

#### `dataverseAPI.getEntityAttributes(entityName, connectionTarget?)`

Get all attributes for an entity.

```typescript
const attributes = await dataverseAPI.getEntityAttributes('account')

attributes.forEach((attr) => {
  console.log(`${attr.LogicalName}: ${attr.AttributeType}`)
})
```

#### `dataverseAPI.getEntitySetName(logicalName)`

Get the entity set name for a given logical name. No connectionTarget needed.

```typescript
const tableSetName = await dataverseAPI.getEntitySetName('contact')

console.log('Entity Set Name for contact:', tableSetName) // Outputs: contacts
```

````typescript

### Actions & Functions

#### `dataverseAPI.executeAction(actionName, parameters)`

Execute a custom action.

```typescript
const result = await dataverseAPI.executeAction('new_CustomAction', {
  InputParameter1: 'value1',
  InputParameter2: 123,
})

console.log('Action result:', result)
````

#### `dataverseAPI.executeFunction(functionName, parameters)`

Execute a custom function.

```typescript
const result = await dataverseAPI.executeFunction('new_CustomFunction', {
  Parameter1: 'value',
})

console.log('Function result:', result)
```

## Error Handling {{ anchor: true }}

All API calls may throw errors. Always use try-catch blocks:

```typescript
try {
  const account = await dataverseAPI.retrieve('account', accountId)
  // Process account
} catch (error) {
  console.error('Failed to retrieve account:', error)

  await toolboxAPI.utils.showNotification({
    title: 'Error',
    body: error.message,
    type: 'error',
    duration: 0, // Persistent
  })
}
```

## Next Steps {{ anchor: true }}

<div className="not-prose mt-6 mb-16 flex gap-3">
  <Button href="/tool-development/examples" arrow="right">
    <>View Examples</>
  </Button>
  <Button href="/tool-development/best-practices" variant="outline">
    <>Best Practices</>
  </Button>
</div>
